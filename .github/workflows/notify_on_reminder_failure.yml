name: Notify on reminder failure

on:
  # Pornește automat când se termină workflow-ul de reminder
  workflow_run:
    # Potrivire robustă: după "name:" și după pathul fișierului
    workflows: ["Run reminder bot", "run_reminder.yml", ".github/workflows/run_reminder.yml"]
    types: [completed]

  # Test manual din UI (optional)
  workflow_dispatch: {}

jobs:
  notify:
    # rulează dacă e test manual SAU dacă run-ul a fost diferit de "success"
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion != 'success')

    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Send alert email
        env:
          # Secretele tale
          SENDER_EMAIL:  ${{ secrets.SENDER_EMAIL }}
          APP_PASSWORD:  ${{ secrets.APP_PASSWORD }}
          DEST_EMAIL:    ${{ secrets.DEST_EMAIL }}
          SMTP_HOST:     ${{ secrets.SMTP_HOST }}
          SMTP_PORT:     ${{ secrets.SMTP_PORT }}

          # Context (doar la workflow_run)
          EVENT_NAME:        ${{ github.event_name }}
          WF_NAME:           ${{ github.event.workflow_run.name }}
          WF_CONCLUSION:     ${{ github.event.workflow_run.conclusion }}
          WF_HTML_URL:       ${{ github.event.workflow_run.html_url }}
          WF_HEAD_SHA:       ${{ github.event.workflow_run.head_sha }}
          REPO:              ${{ github.repository }}
        run: |
          python - <<'PY'
          import os, smtplib
          from email.message import EmailMessage

          def clean(s): 
              return " ".join((s or "").replace("\r"," ").replace("\n"," ").split())

          sender = clean(os.getenv("SENDER_EMAIL",""))
          to     = clean(os.getenv("DEST_EMAIL", sender))
          host   = clean(os.getenv("SMTP_HOST","smtp.office365.com"))
          try:
              port = int(os.getenv("SMTP_PORT","587"))
          except:
              port = 587

          if not sender or not os.getenv("APP_PASSWORD"):
              raise SystemExit("Lipsesc SENDER_EMAIL/APP_PASSWORD in secrete.")

          if os.getenv("EVENT_NAME") == "workflow_dispatch":
              subject = "[ALERTA-TEST] Run reminder bot (test manual)"
              body = "Acesta este un test manual al workflow-ului de notificare."
          else:
              subject = f"[ALERTA] {os.getenv('WF_NAME','Run reminder bot')} a esuat: {os.getenv('WF_CONCLUSION','unknown')}"
              body = f"""Salut,

Workflow-ul principal a incheiat CU PROBLEME.

Repo: {os.getenv('REPO')}
Workflow: {os.getenv('WF_NAME')}
Stare finala: {os.getenv('WF_CONCLUSION')}
Run URL: {os.getenv('WF_HTML_URL')}
Commit: {os.getenv('WF_HEAD_SHA')}

Verifica tab-ul Actions pentru detalii.
"""

          msg = EmailMessage()
          msg["From"] = sender
          msg["To"] = to
          msg["Subject"] = clean(subject)
          msg.set_content(body)

          with smtplib.SMTP(host, port) as s:
              s.starttls()
              s.login(sender, os.getenv("APP_PASSWORD"))
              s.send_message(msg)
          PY